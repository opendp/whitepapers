\documentclass[11pt,a4paper]{article}
\usepackage{amsmath,amsthm,amsfonts,amssymb,amscd}
\usepackage{enumerate} 
\usepackage{physics}
\usepackage{enumerate}
\usepackage{fancyhdr}
\usepackage{hyperref}
\usepackage{graphicx}
\hypersetup{colorlinks,
    linkcolor=blue,
    citecolor=blue,      
    urlcolor=blue,
    %linktoc=none
}

\oddsidemargin0.1cm 
\evensidemargin0.8cm
\textheight22.7cm 
\textwidth15cm \topmargin-0.5cm

\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem*{theorem-non}{Theorem}

\theoremstyle{definition}
\newtheorem{remark}{Remark}
\newtheorem{definition}{Definition}[section]
\newtheorem{observation}{Observation}
\newtheorem{note}{Note}
\newtheorem{hope}{Hope}
\newtheorem{warning}{Warning}
\newtheorem{problem}{Problem}
\newtheorem{fear}{Fear}
\newtheorem{question}{Question}
\newtheorem{example}{Example}
\newtheorem{claim}{Claim}

\newcommand{\Z}{\mathbb{Z}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\A}{\mathbb{A}}
\newcommand{\horizline}{\noindent\rule{\textwidth}{1pt}}

\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\newcommand{\MultiSet}{\mathrm{MultiSet}}
\newcommand{\len}{\mathrm{len}}
\newcommand{\din}{d_{in}}
\newcommand{\dout}{d_{out}}
\newcommand{\Relation}{\mathrm{Relation}}
\newcommand{\X}{\mathcal{X}}
\newcommand{\Y}{\mathcal{Y}}
\newcommand{\True}{\texttt{True}}
\newcommand{\False}{\texttt{False}}
\newcommand{\clamp}{\texttt{clamp}}
\newcommand{\questionc}[1]{\textcolor{red}{\textbf{Question:} #1}}
\newcommand{\T}{\texttt{T}}

\newcommand{\silvia}[1]{{ {\color{blue}{(silvia)~#1}}}}
\newcommand{\grace}[1]{{ {\color{purple}{(grace)~#1}}}}
\newcommand{\connor}[1]{{ {\color{teal}{(connor)~#1}}}}

\newcommand{\todo}{{\textcolor{red}{TODO }}}

\title{List of definitions used in the proofs}
\author{S\'ilvia Casacuberta, Grace Tian, and Connor Wagaman}
\date{June--July 2021}

\begin{document}

\maketitle

We use the following guideline: if a term appears in the preconditions \& pseudocode section, then this term is defined in the ``List of definitions used in the pseudocode" document. Otherwise, it appears in the ``List of definitions used in the proofs" document. 

In both cases, we maintain the terms in alphabetical order within each section. `TODOs'' should be included at the end of the corresponding section. On the other hand, ``TODOs'' which better specify an already-defined term should be included immediately following the definition of that term. Examples should never be part of the definition, but we encourage their use right after the definition of a term.

\tableofcontents

\section*{List of terms that have not yet been added}
\begin{itemize}
\item ...
\end{itemize}

\section{Mathematical operators}
\questionc{We would like to discuss how to approach this section further.}

The notation we are using for various mathematical operations is, as of 24 June 2021, inspired by section 2 of \url{https://hal-ens-lyon.archives-ouvertes.fr/ensl-01529804/file/crlibm.pdf}. (The notation may change in the future.) We plan to use a similar standardized notation for describing the semantics of \href{https://www.mpfr.org/}{MPFR}.\footnote{Library used in OpenDP to deal with floating point arithmetic.}

\begin{definition}[$+, -, \times$]
    The symbols $+$, $-$, and $\times$ represent the usual mathematical operations of addition, subtraction, and multiplication, respectively.
\end{definition}

\begin{definition}[$\oplus, \ominus, \otimes$]
    The symbols $\oplus$, $\ominus$, and $\otimes$ denote the corresponding floating point operations in \href{https://www.mpfr.org/}{MPFR} / in Rust arithmetic. 
\end{definition}

\connor{Maybe change ``floating point operations in \href{https://www.mpfr.org/}{MPFR}'' to some other thing that it denotes. I'm not sure if they should ``denote the corresponding floating point operations in \href{https://www.mpfr.org/}{MPFR}'', but I wanted to preserve the notation, and I wasn't sure what it should be defined on \ldots.}
    
\silvia{Use same notation in both pseudocode and proofs?}

\todo{Change to cast.}\connor{I don't understand this todo; could someone else complete it?}
\begin{definition}
    Given a Rust value $x$, the function \texttt{val(x)} returns the actual (real or integer) number represented by the Rust value $x$.

\end{definition}

\horizline

\subsection{Notes, todos, questions}

\todo{Add the cast definition?}

\todo{max, min, val(x) (give number represented by Rust value), see email from June 21. Subindex for type?}

\todo{Max and min require TotalOrd}

\todo{Add special float symbol for max, min?} No, from discussion on June 28: as long as we pass as arguments things that have used float symbols, it's OK.

\questionc{Type in subindex vs casting type.}
\connor{What does ``subindex for type'' mean (see todo above for use of this phrase; meaning possibly relates to question in this line)?} \silvia{I think it means deciding between, for example, $\texttt{max}_{\texttt{u32}}(x, y)$ or $\texttt{cast(max(x, y), u32)}$.}

\section{Data Representation}

\begin{definition}[Vector]
A vector $v$ is an ordered list of objects.
\end{definition}

\begin{definition}[Set]
A set is an unordered list of objects.
\end{definition}

\begin{definition}[Multiset]
A multiset is a modification of the notion of a set which, unlike a set, allows for repetitions for each of its elements. The number of repetitions of an element in the multiset corresponds to the \textit{multiplicity} of that element. \questionc{multiset vs MultiSet.} \silvia{Add what we said on July 15.}
\end{definition}

%\silvia{Sets are by definition unordered, no need to specify that in the 2nd sentence.}

\begin{remark}
Given a vector $v$, we denote its multiset representation by $\MultiSet(v)$. This distinction is relevant because vectors are ordered objects whereas multisets are not. In the OpenDP library, all datasets are represented as vector domains, and therefore for any vector $v$ we need to use the notation $\MultiSet(v)$ when referring to its multiset representation to indicate that ordering should be dropped. \questionc{Clashes a bit with the $\MultiSet(\X)$ use in the PF; domain vs vector.} \silvia{This should be resolved after consensus on July 15.}
\end{remark}

\begin{example}
    Given $\MultiSet(2, 3, 3, 5, 5, 5 )$, element 2 has multiplicity 1, element 3 has multiplicity 2, and element 5 has multiplicity 3.
\end{example}

\questionc{Is this clear enough? Because this is very important.} \connor{Note: As of July 12, 2021, it may be less important since we may not need multisets anymore -- for example, we now have a ``vector-first'' definition for symmetric distance that we can use.} \silvia{Still needs discussion: defining terms in a ``vector-first" manner to avoid using $\MultiSet(v)$ in the proofs.}

\questionc{We should decide on whether we want to keep a vector approach or a multiset approach:}
\begin{definition}[Histogram notation, multiset version]
\label{defn:histogram}
    Let $h_x: \mathcal{X} \rightarrow \mathbb{N}$ be the histogram of a multiset $x \in \MultiSet(\mathcal{X} )$ for some domain $\mathcal{X}$. That is, $h_x(z)$ denotes the number of occurrences of $z \in \mathcal{X}$ in multiset $x$ (with multiplicities).
\end{definition}

%\todo{Change to vector domain notation. For vector $v$, $h_v(z)$ denotes the number of occurrences of $z$ in $\MultiSet(v)$.} \todo{Specify types: z?}

\begin{definition}[Histogram notation, vector version]
    For any vector $v$ of elements of a domain \texttt{D}, $h_v$ denotes the histogram of $v$. That is, for every element $z$ of type \texttt{T}, $h_v(z)$ denotes the number of occurrences of $z \in \texttt{D}$ in the entries of vector $v$ (with multiplicities).
\end{definition}

%Given a vector $v$ in some vector domain, $h_v(z)$ denotes the number of occurrences of $z$ in $\MultiSet(v)$.

\section{Transformations \& Stability relation}
%\silvia{Transformations here? Section for them?}
\begin{definition}[Transformation]
    A transformation $T$ is a \textit{deterministic} mapping from arbitrary data types of derived data values to arbitrary data types of derived data values. In Rust, a transformation is specified by the following attributes: input domain, output domain, function, input metric, output metric, and stability relation. 
\end{definition}

See \href{https://www.overleaf.com/project/60d215bf90b337ac02200a99}{``List of definitions used in the pseudocode"} for further details of the pseudocode specification of a transformation.

%\silvia{Not c in R}
\begin{definition}[Stability parameter]\label{def:c}
    For some value of $c$, we say that a transformation $T$ is $c$\textit{-stable} if for all $x, x'$ in the input domain $\X$, and for input metric $d_{\X}$ and output metric $d_{\Y}$,
    \begin{equation}
        d_{\mathcal{Y}}(T(x), T(x')) \leq c \cdot d_{\mathcal{X}}(x, x').
    \end{equation}
    We say that $c$ is the \textit{stability parameter} of $T$.
\end{definition}

\silvia{Why does the PF define the stability relation like this? There are cases where the $c \cdot d_{\X}(x, x')$ multiplicative constant scheme does not quite work; e.g., for clamping with absolute distance the stability relation is $\dout \geq \min(\din, U-L)$.} 

In the Rust code, the stability parameter $c$ (which in the case of clamping is equal to~1) gets wrapped up inside of the stability relation property, and the end user can test it empirically. \todo{Explain better -- but perhaps in the general guidelines doc?}

\begin{definition}[Stability relation]
    The \textit{stability relation}, denoted $\Relation(\din, \dout)$, is a boolean function which takes as input some $\din, \dout$ appropriately quantified and returns \texttt{True} if and only if the relation $\dout \geq c \cdot \din$ for some specified value of $c$. 
\end{definition}

We can also write the stability relation in the following form:

\begin{equation}
    \Relation(\din, \dout) = 
    \begin{cases} 
      \True & \textrm{if } \dout \geq c \cdot \din \\
      \False & \textrm{otherwise},
   \end{cases}
\end{equation}
specifying the concrete metrics $d_{\X}, d_{\Y}$ and types of $\din, \dout$ inside the function.

The associated type of $d_{\X}$ is equal to the type of $\din$, and the associated type of $d_{\Y}$ is equal to the type of $\dout$. Importantly, such relations are sound but \textit{not necessarily complete}. A transformation is considered \textit{valid} if its stability relation is sound.

%\begin{definition}[Relation]
%Relation($d_{in}$, $d_{out}$) means that \grace{Silvia can you add what you had for Relation here?}
%\end{definition}

\subsection{Stability for Randomness}


The following lemma and corollary are used to prove the stability guarantee holds in random transformations like \texttt{make\_impute}. 
\begin{lemma}[Stability for Randomness]
We define a randomized function $f: \texttt{DI} \rightarrow \texttt{DO}$. $\Relation(d_{in}, d_{out}) = True$ implies that for all $x, x' \in$ \texttt{DI} that are $d_{in}$-close, there exists a coupling $(R, R')$ of the randomness of $f(x)$ and $f(x')$ such that for all $(r, r') \in Support(R, R'),$ $f_r(x)$ is $d_{out}$-close to $f_{r'}(x')$.
\end{lemma}

\silvia{Proof?}

The following corollary allows us to fix the random seed in random transformations to prove the stability guarantee.

\begin{corollary}
For randomized function $f: \texttt{DI} \rightarrow \texttt{DO}$, $\Relation(d_{in}, d_{out}) = True$ implies that for all $x, x' \in$ \texttt{DI} that are $d_{in}$-close and for all fixing of the randomness $r$ of $f$ (fixing seed of PRG), we have that $f_r(x)$ and $f_r(x')$ are $d_{out}$-close.
\end{corollary}

\horizline

\subsection{Notes, todos, questions}

\todo{Add explanation on forward and backward map?}

%\silvia{TODO: define first the customary definition for sym dist}
%\silvia{TODO: and make it correct for multisets}

\section{Metrics}
\silvia{Very important to always specify the types and domains when presenting metrics! (remarks from 24/6 Prof. Vadhan's OH) So:}

%\silvia{With that, changed multisets to vectors, but have we made it clear enough that this is how OpenDP is representing multisets? E.g., $u \Delta v$ is the multiset vs $u \Delta v$ is the vector corresponding to... (see below)}

\silvia{From meeting on July 13: each metric definition must contain its associated type and the list of possible domains it works with. This is not explicitly specified in Rust (i.e., the metric is only a name), but every time we find a transformation / measurement which uses the metric, include the corresponding domain in the definition if it is not there already. It should also include what it means to be $\din$ close under that metric.}

\connor{Because the Rust type on which a metric operates is covered in the pseudocode definitions, I think we just need to talk mathematically here, like ``symmetric distance is defined on vectors''.}

\silvia{On July 15 we settled on only writing the mathematical definition in this document, and then writing the Rust list of domains and associated types in the pseudocode definitions document.}

The associated type of any input metric is the type of the corresponding $\din$. In turn, the associated type of any output metric is the type of the corresponding $\dout$.

\subsection{Symmetric distance}
\begin{definition}[Symmetric difference]
The \textit{symmetric difference} between any two vectors $u, v$, denoted by $\MultiSet(u)\Delta \MultiSet(v)$, corresponds to the multiset representation of elements which are in either $u$ or $v$ but not in their intersection. The multiplicity of each element $x$ in $\MultiSet(u)\Delta \MultiSet(v)$ corresponds to the difference in absolute value of the multiplicities of $x$ in $\MultiSet(u)$ and in $\MultiSet(v)$.

%\connor{I think we should have an explanation of what is means for an element to be in, for example, $u$ but not in $v$. For example, if we have $u = \MultiSet(0,0,1)$ and $v = \MultiSet(0)$, is $0$ in $v$ or not? We want it to be that ``the first $0$ is in $v$, but the second $0$ is not in $v$'', but I don't think the current definition gets that message across.}

%\todo{Improve this definition}
\end{definition}

%\todo{Changed my mind after preconditions: better to say symmetric distance than \texttt{SymmetricDistance} (no longer appears in pseudocode)}

%\todo{Still unclear which information should be part of the metric. Mike said on 7/6 not to include the list of possible domains, but then where do we say $u, v$ belong to? Mike also said that he is not sure whether the \texttt{u32} should be part of the definition.}

%\silvia{Should change to \texttt{SymmetricDifference}, right?}

\silvia{In all these metric definitions, be careful about associated type and not to say input/output type. We never think of metrics as functions in the usual sense; instead, the associated type of distance is the type of $\din$. When defining the metrics, we need to specify to which type of domains it applies.}


%\silvia{Cardinality of MultiSet(v). Comment on Slack about no input vs output type.}

\begin{example}
Because a multiset can have repeated elements, for $a = \MultiSet(1,2,1)$ and $b = \MultiSet(1,3)$, we have $a\Delta b = \MultiSet(1,3, 2)$. 
\end{example}

%\grace{I think there's a typo. Originally it said that $a\Delta b = \MultiSet(1,3,2)$.}

%\connor{Fixed now -- thanks for the catch!}

We introduce the notion of symmetric distance, which differs from symmetric difference in that it is the \emph{cardinality} of the multiset instead of the multiset itself.

\begin{definition}[Symmetric distance]
The \textit{symmetric distance} between any two vectors $u, v$, denoted $d_{Sym} = |\MultiSet(u) \Delta \MultiSet(v)|$, is equal to the cardinality of the symmetric difference between $u$ and $v$.
\end{definition}

%\connor{Do you think we should leave out the associated type above? The associated type may be more of a job for the pseudocode definitions since types aren't really mentioned in this doc.}

\begin{definition}[$\din$-close under $d_{Sym}$]
    For any two vectors $u, v \in \texttt{VectorDomain(D)}$ and $\din$ of type \texttt{u32}, we say that $u, v$ are $\din$-close under $d_{Sym}$ whenever $d_{Sym}(u, v) = |\MultiSet(u) \Delta \MultiSet(v)| \leq \din$. \silvia{Should this also be moved to the pseudocode defs document now that the list of domains and associated type is there?}
\end{definition}

The same definition holds for $\dout$.

Note: symmetric distance is the metric which is used in the OpenDP library, while the definition symmetric difference is only included for completeness in this document.

% still working on this paragraph
Because there is a bijection between histograms and multisets, we can also define the \emph{symmetric distance} between $u$ and $v$ as the $\ell_1$ distance between the histograms for $u$ and $v$, denoted $h_u$ and $h_v$ (see Definition \ref{defn:histogram}). Then, we equivalently obtain that the symmetric distance between $u$ and $v$ is
$$d_{\text{Sym}}(u,v) = \lVert h_{v} - h_{w}\rVert_1 = \sum_{z\in \mathcal{X}} |h_u(z) - h_{v}(z)|.$$

The second equality follows from the definition of $\ell_1$ distance.

\silvia{Add the above as claim?}

\connor{Since these definitions are all written by us, I think we could say that we're defining symmetric distance as both things.}

\medskip
\textbf{Alternative definition of symmetric distance.}

Let $u,v$ be vectors of elements drawn from domain $\mathcal{X}$. Define $m_v(\ell)$ as the multiplicity of element $\ell$ in vector $v$. For example, if $v$ contains five instances of the number ``21'', then $m_v(21) = 5$.

An alternative definition of symmetric distance, then, is $$d_{\text{Sym}}(u,v) = \sum_{z\in \mathcal{X}} |m_u(z) - m_v(z)|.$$

\questionc{Which definition should we go with? Original definition, alternative definition, or both?}

\begin{claim}
Symmetric distance is a metric.
\end{claim}

Note that null data values are still counted in the symmetric distance. Adding or removing null values still influences the count.

\medskip
\textbf{The path property of symmetric distance on sized domains.}

\questionc{Given that we are avoiding texttt notation in this document, should we change \texttt{SizedDomain} for a mathematical definition of sized domain in the three lemmas that follow?}

\begin{lemma}[Path property of $d_{Sym}$ on \texttt{SizedDomain}]
    For any two vectors $v, w$ of the same length (that is, for any two vectors $v, w \in$ \texttt{SizedDomain(D)} for some domain \texttt{D}), $d_{Sym}(v,w)$ is an even integer; i.e., $d_{Sym}(v,w) = 2k$ for some integer $k \geq 0$. Moreover, there exist $k$ vectors $v=v_0, v_1, \ldots, v_k=w$ such that $d_{Sym}(v_i,v_{i+1})=2$ for all $i$.
\end{lemma}

%\grace{Could you restate the path property lemma above so that it's clear what are the assumptions and implications?}

Note that the path property of symmetric distance only holds in bounded domains (i.e., \texttt{SizedDomain}); that is, when the length of the input vectors is fixed.

\begin{lemma}
    For any two vectors $v, w \in$ \texttt{SizedDomain(D)}, $d_{Sym} = 2$ if and only if we can change one element of $v$ to obtain $v'$ such that $\MultiSet(v') = \MultiSet(w)$.
\end{lemma}

The above lemma follows directly from the definition of symmetric distance. 

%\begin{lemma}
    %If for all vectors $v, w$ and functions $f$ such that whenever $d_{Sym}(v, w) = 2$ we have that $\dout(f(v), f(w)) \leq c$, then $f$ is $c/2$-stable.
%\end{lemma}

\begin{lemma}
Given a function $f$ on input domain \texttt{SizedDomain(D)}, if $\dout(f(v), f(w)) \leq c$ for all vectors $v, w$ such that $d_{Sym}(v, w) = 2$, then $f$ is $c/2$-stable.
\end{lemma}

By the definition of $c$-stable (Definition~\ref{def:c}), 
that $f$ is $c/2$-stable is equivalent to stating that for all pairs $v', w'$ in the input domain, the following holds:
\[
    d_{\Y}(f(v'), f(w')) \leq c/2 \cdot d_{Sym}(v', w').
\]
Also equivalently, this means that the stability relation of $f$ is
\[
    \dout \geq c/2 \cdot \din.
\]



\subsection{Substitute distance}
\begin{definition}[Substitute distance]
We only define the \emph{substitute distance} $d_{Sym}$ on multisets with the same number of elements. On two multisets $u,v\in \MultiSet(\mathcal{X})$ for some domain $\mathcal{X}$ where $|u| = |v|$, we say that the substitute distance $d_{Subs}(u,v)$ is equal to the cardinality of the relative complement $u \backslash v$, so $d_{Subs}(u,v) = |u\backslash v|$. (This can be thought of as fixing multiset $u$ and finding how many elements in $v$ are not represented in $v$.) \silvia{List of domains? Associated types? It is not in the library, so we cannot answer this -- maybe we should drop it.}

\connor{Substitute distance should have the same domain as symmetric distance since it is defined as half the symmetric distance. Probably the same ``associated type'', too, but I don't think we need to cover that here.}

Alternatively, we can define $d_{Subs}$ as


$$d_{Subs}(u,v) = \frac{1}{2}d_{\text{Sym}}(u,v).$$

Note that this metric is like a generalization of Hamming distance to multisets (recall that Hamming distance is defined on ordered objects). \silvia{If we say ``recall" then Hamming distance should be defined and explained.} \todo{Add Hamming? It is never used, so I would drop it.}
\end{definition}
\silvia{I would not define $d_{Subs}$ in terms of $d_{Sym}$; and instead write original definition and then add the 2-factor equality as a claim.}
\connor{I think they had defined $d_{subs}$ in terms of $d_{sym}$.}

\begin{claim}
Substitute distance is a metric.
\end{claim}

%\begin{claim}
%(2 factor of Subs and Sym)
%\end{claim}

\begin{remark}
    As of June 24, substitute distance has been removed from the library as a possible dataset metric. Therefore, symmetric distance is currently the only available dataset metric in the OpenDP library.
\end{remark}

\subsection{Absolute distance}

\begin{definition}[Absolute distance]\label{def:abs}
    Given two numbers $n, m$, the absolute distance between $n$ and $m$, denoted $d_{Abs}$, is defined as $d_{Abs}(n, m)= |n-m|$, where the horizontal bars represent absolute value.
\end{definition}

\begin{definition}[$\din$-close under $d_{Abs}$]
    For any two elements $n, m$ in \texttt{AllDomain(T)}, where \texttt{T} denotes an arbitrary type with trait \texttt{Sub(Output=T)}, and $\din$ of generic type \texttt{Q}, we say that $n, m$ are $\din$-close under $d_{Abs}$ whenever $d_{Abs}(n, m) = |n-m| \leq \din$.
\end{definition}

The same definition holds for $\dout$.

\begin{claim}
    Absolute distance is a metric.
\end{claim}

\subsection{Distances}
\begin{definition}[$k$-close]
For any metric $d$, we say that two elements $u, v$ are $k$-close under $d$ if $d(u, v) \leq k$.
\end{definition}

 \silvia{Important: $\din, \dout$ is more general than metrics; e.g., $(\epsilon, \delta)$-DP.}

For example, in the case of symmetric distance, vectors $u$ and $v$ are $k$-close whenever $d_{Sym}(u, v) = |\textrm{MultiSets}(v) \Delta \textrm{MultiSets}(u)| \leq k$. We remark that the type of $k$ must correspond to the associated type of $d$.

We remark that the notion of $k$-closeness can be defined more generally without relying on metrics and instead only using $\din, \dout$. If that is the case, it will be defined accordingly.

\horizline

\subsection{Notes, todos, questions}

\todo{Make sure to cite Programming Framework when required.}


\end{document}
